// 网易云音乐插件 - MusicFree 官方协议
const musicSource = {
  name: '网易云音乐',
  version: '1.0.0',
  platform: 'netease',
  
  // API 列表（自动切换）
  apiList: [
    'https://netease-cloud-music-api-ruby.vercel.app',
    'https://music-api.leanapp.cn',
    'https://netease-api.vercel.app',
    'https://api.netease.com'
  ],
  
  // 搜索歌曲
  async search(keyword) {
    const limit = 30;
    
    for (let i = 0; i < this.apiList.length; i++) {
      try {
        const api = this.apiList[i];
        const url = api + '/search?keywords=' + encodeURIComponent(keyword) + '&type=1&limit=' + limit;
        
        const response = await fetch(url, {
          headers: {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
          }
        });
        
        if (!response.ok) {
          continue;
        }
        
        const data = await response.json();
        const songs = data.result && data.result.songs ? data.result.songs : [];
        
        const result = [];
        for (let j = 0; j < songs.length; j++) {
          const song = songs[j];
          result.push({
            id: String(song.id),
            title: song.name,
            artist: song.artists && song.artists.length > 0 ? song.artists[0].name : '未知艺术家',
            album: song.album && song.album.name ? song.album.name : '未知专辑',
            duration: song.duration ? Math.floor(song.duration / 1000) : 0,
            cover: song.album && song.album.picUrl ? song.album.picUrl : '',
            platform: 'netease',
            platformId: String(song.id),
            url: '',
            lyric: ''
          });
        }
        
        return result;
      } catch (error) {
        console.log('网易云 API #' + (i + 1) + ' 失败，尝试下一个...');
        continue;
      }
    }
    
    throw new Error('所有网易云 API 都失败了');
  },
  
  // 获取播放 URL
  async getPlayUrl(songItem) {
    for (let i = 0; i < this.apiList.length; i++) {
      try {
        const api = this.apiList[i];
        const url = api + '/song/url?id=' + songItem.platformId + '&br=320000';
        
        const response = await fetch(url, {
          headers: {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
          }
        });
        
        if (!response.ok) {
          continue;
        }
        
        const data = await response.json();
        const playUrl = data.data && data.data.length > 0 && data.data[0].url ? data.data[0].url : '';
        
        if (playUrl) {
          return playUrl;
        }
      } catch (error) {
        console.log('获取播放 URL 失败: ' + error.message);
        continue;
      }
    }
    
    throw new Error('无法获取播放 URL');
  },
  
  // 获取歌词
  async getLyric(songItem) {
    for (let i = 0; i < this.apiList.length; i++) {
      try {
        const api = this.apiList[i];
        const url = api + '/lyric?id=' + songItem.platformId;
        
        const response = await fetch(url, {
          headers: {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
          }
        });
        
        if (!response.ok) {
          continue;
        }
        
        const data = await response.json();
        const lyric = data.lrc && data.lrc.lyric ? data.lrc.lyric : '';
        
        return lyric;
      } catch (error) {
        console.log('获取歌词失败: ' + error.message);
        continue;
      }
    }
    
    return '';
  }
};

// 导出
if (typeof module !== 'undefined' && module.exports) {
  module.exports = musicSource;
}
